\input setup

\title Scanning macro arguments

\section 1. Playing with getoptag

\def\makeattribute#1{$\left\{\mbox{#1}\right\}$}

\def\taga{\makeattribute{A}}

\def\tagb#1{\makeattribute{B = #1}}

\def\tagc#1{%
  \teststrempty{#1}%
  \ifstrempty
    \makeattribute{C}%
  \else
    \makeattribute{C = #1}%
  \fi
}

\def\getopttrial{%
  \def\getopttagvoid{\\{\taga}}
  \def\getopttagmandatory{\\{\tagb}}
  \def\getopttagbracket{\\{\tagc}}
  \getopttag\getopttrial@M
}

\def\getopttrial@M#1{%
  \noindent
  \hbox to .6\hsize{\##1\#\hfill\#}%
  \ignorespaces
}

\begingroup
\obeylines
\getopttrial\taga 		Off with her head!
\getopttrial\taga\taga		Off with her head!
\getopttrial\tagb 1		Off with her head!
\getopttrial\tagb{2}\taga	Off with her head!
\getopttrial\tagc[3]\tagc	Off with her head!
\getopttrial\tagb{4}\tagc\taga	Off with her head!
\endgroup


\section 2. Read blanks then trigger a callback

\def\discardblanks@L#1{%
  \beginnext
    \def\rmA{#1}%
    \def\rmB{\stop}%
    \ifx\rmA\rmB
      \let\next=\relax
    \else
      \def\next{#1\discardblanks}%
    \fi
  \endnext
}

\def\discardblanks{%
  \readblanks\then\discardblanks@L\done
}

\medskip
\noindent
This is how we are discarding blanks:
\begindisplay
\discardblanks AB C D EFG HI JK L\stop
\enddisplay
Note that macros in the argument are not expanded, so if you put the
macro `space' between D and EFG, you will get
\begindisplay
\discardblanks AB C D\space EFG HI JK L\stop
\enddisplay


\section 3. Read specifications

The specifications we want to read look like those appearing in {\TeX}
boxes specifications.

\def\getoptspecreset{%
  \let\getoptspecvoid\empty
  \let\getoptspecmandatory\empty
  \let\getoptspecbracket\empty
}

\def\getoptspec@P#1{%
  \beginnext
  \let\next\@false
  \ifcat A\noexpand#1\let\next\@true\fi
  \endnext
}

\def\getoptspec{%
  \beginnext
  \readtokens\getoptspec@P\to\rtA\then\getoptspec@L\done
}

\def\getoptspec@A#1#2{%
  \ifflag\else
    \beginnext
    \rtB={\toksloadalistvalue#1}%
    \rtC={\to\rtB}%
    \edef\next{\the\rtB{\the\rtA}\the\rtC}%
    \endnext
    \ifexception\else
      \flagtrue
      \rtD{#2}%
    \fi
  \fi
}

\def\getoptspec@L{%
  % We look for the identifier stored in rtA
  % in the association lists getoptspecvoid, getoptspecmandatory,
  % getoptspecbracket.
  \flagfalse
  \rtD{\getoptspec@E}%
  \getoptspec@A\getoptspecvoid\getoptspec@V
  \getoptspec@A\getoptspecmandatory\getoptspec@M
  \getoptspec@A\getoptspecbracket\getoptspec@B
  \ifflag
    \edef\next{%
      \noexpand\readblanks
      \noexpand\then
      \the\rtD
      \noexpand\done
    }%
  \else
    % We did not find a match
    %  and rtD = {\getoptspec@E}
    \def\next{\the\rtD}%
  \fi
  \next
}

\def\getoptspec@E{%
  % We reached the end of the specification and
  % put back the tokens stored in rtA on the input
  \edef\next{\the\rtA}%
  \endnext
}

\def\getoptspec@V{%
  % Specifications without values
  %  we give control to the callback
  %  and start the whole thing again
  \edef\next{\the\rtB}%
  \endnext
  \getoptspec
}

\def\getoptspec@M{%
  % Specifications with a value
  %  we expect the value linked with the key rtA
  %  to call again readspec on its own
  \edef\next{\the\rtB}%
  \endnext
}

\def\getoptspec@B{%
  % Specifications with an optional bracket value
  \getoptbracket\getoptspec@C
}

\def\getoptspec@C#1{%
  \rtA={#1}%
  \edef\next{\the\rtB{\the\rtA}\noexpand\getoptspec@S}%
  \endnext
}

\def\getoptspec@S{%
  \readblanks\then\getoptspec\done
}

\def\getoptspec@R{%
  \afterassignment\getoptspec@S
}

%
% Un exemple
%

\def\testgetoptspec#1#{\testgetoptspec@M{#1}}

\def\testgetoptspec@M#1#2{%
  \rdA=0pt
  \rdB=0pt
  \rdC=0pt
  \getoptspecreset
  \def\getoptspecmandatory{%
    \\{{width}{\getoptspec@R\rdA}}%
    \\{{height}{\getoptspec@R\rdB}}%
    \\{{depth}{\getoptspec@R\rdC}}%
  }%
  \def\getoptspecbracket{%
    \\{{star}{\makestar}}%
  }%
  \def\makestar##1{%
    \def\makestar@x{##1}%
  }%
  \let\makestar@x\undefined
  %
  % Here we go
  %
  We process the sequence
  \begindisplay
  \tt #1$\{$#2$\}$%
  \enddisplay
  through `readspec' now.
  \par
  \tt
  START\par
  \getoptspec#1{#2}\par
  STOP\par
  \normalfont
  \begindisplay\tt
  \indent
  \ifx\makestar@x\undefined\else
     \ifx\makestar@x\empty
       \llap{* }%
     \else
       \llap{\makestar@x\space}%
     \fi
  \fi
  rdA = \the\rdA\endgraf
  rdB = \the\rdB\endgraf
  rdC = \the\rdC\endgraf
  \enddisplay
}

\testgetoptspec star width 12pt height 16pt depth 13pt{text}
\testgetoptspec star[\P]width 12pt height 16pt depth 13pt{text}
\testgetoptspec star [\P] width 12pt height 16pt depth 13pt{text}


\meaning\ignoreblanks@l
\meaning\spacetoken
\meaning\tabtoken
\meaning\newlinetoken

\bye
